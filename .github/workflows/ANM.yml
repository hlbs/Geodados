name: Sync ANM via CloudFlare and Worker (Release .gz)

on:
  schedule: [{ cron: "15 6 * * *" }]   # 06:15 UTC ~ 03:15 BRT
  workflow_dispatch:

# << 1) Permissão de escrita p/ criar tag/release >>
permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # fetch-depth: 0 ajuda com tags
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: url-encode helper
        run: |
          printf '%s\n' '#!/usr/bin/env python3' 'import sys,urllib.parse;print(urllib.parse.quote(sys.argv[1],safe=""))' > urlenc.py
          chmod +x urlenc.py

      - name: Baixar via Worker e compactar
        env:
          WORKER_BASE: "https://anm.hermesbarros-eng.workers.dev"   # <<< Subdomínio-CloudFlare
        run: |
          set -euo pipefail
          dl () {
            SRC="$1"; OUT="$2"
            ENC=$(./urlenc.py "$SRC")
            URL="$WORKER_BASE/?u=$ENC"

            # retries + timeouts generosos
            curl --http1.1 --ipv4 -L \
                 -H "User-Agent: Mozilla/5.0" \
                 -H "Accept: text/csv,*/*;q=0.1" \
                 --retry 6 --retry-delay 10 --retry-all-errors \
                 --connect-timeout 60 --max-time 1800 \
                 -o "$OUT" "$URL"
            [ -s "$OUT" ] || (echo "Falha ao baixar $SRC"; exit 28)
            gzip -f -k "$OUT"   # gera $OUT.gz
          }

          dl "https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Arrecadacao.csv"  CFEM_Arrecadacao.csv
          dl "https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Distribuicao.csv" CFEM_Distribuicao.csv
          dl "https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Autuacao.csv"     CFEM_Autuacao.csv
          dl "https://app.anm.gov.br/DadosAbertos/AMB/Producao_Bruta.csv"            Producao_Bruta.csv
          dl "https://app.anm.gov.br/DadosAbertos/AMB/Producao_Beneficiada.csv"      Producao_Beneficiada.csv

      # << 2) Garantir/atualizar a tag 'latest' antes da release >>
      - name: Garantir/atualizar tag 'latest'
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch --tags
          git tag -f latest
          git push -f origin latest

      # << 3) Passar o token via 'with.token' >>
      - name: Publicar Release "latest"
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: latest
          files: |
            CFEM_Arrecadacao.csv.gz
            CFEM_Distribuicao.csv.gz
            CFEM_Autuacao.csv.gz
            Producao_Bruta.csv.gz
            Producao_Beneficiada.csv.gz
          token: ${{ secrets.GITHUB_TOKEN }}
