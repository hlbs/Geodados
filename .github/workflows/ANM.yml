name: Sync ANM → GitHub Release (via CF Worker, CSV cru + fallback)

on:
  schedule:
    - cron: "15 6 * * *" # 06:15 UTC (~03:15 BRT)
  workflow_dispatch:

permissions:
  contents: write

env:
  WORKER_BASE: "https://anm.hermesbarros-eng.workers.dev" # usa ?u=URL CRUA
  UA: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome Safari"

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preparar ambiente (curl, jq, gh)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y curl jq gh
          mkdir -p out

      - name: Baixar CSVs (Worker → Bounce → Direto)
        shell: bash
        run: |
          set -euo pipefail
          cd out

          # opções comuns do curl (modo "anônimo" sem cookies)
          COMMON_CURL_OPTS=(
            -L --fail --http1.1 --ipv4
            --retry 12 --retry-delay 10 --retry-all-errors --retry-connrefused
            --connect-timeout 60 --max-time 0
            # Removidos: --speed-time 120 --speed-limit 16384
            -H "User-Agent: ${UA}"
            -H "Accept: text/csv,application/octet-stream,*/*;q=0.1"
            -H "Accept-Encoding: identity"
            -H "Pragma: no-cache"
            -H "Cache-Control: no-cache"
            -H "Cookie:"
          )

          small_check () {
            local f="$1" min="$2"
            local sz
            sz=$(wc -c < "$f" | tr -d ' ')
            echo ">> $f bytes=$sz"
            if [ "$sz" -lt "$min" ]; then
              echo "!! Pequeno demais ($sz < $min)"
              return 66
            fi
          }

          try_all () {
            local src="$1" out="$2" min="${3:-2048}"

            echo "==> 1) Worker direto"
            if curl "${COMMON_CURL_OPTS[@]}" --continue-at - -o "${out}.part" \
              "${WORKER_BASE}/?u=${src}"; then
              mv "${out}.part" "$out" && small_check "$out" "$min" && return 0
            fi
            rm -f "${out}.part" || true

            echo "==> 2) Worker bounce → 302 → origin"
            if curl "${COMMON_CURL_OPTS[@]}" --continue-at - -o "${out}.part" \
              "${WORKER_BASE}/?bounce=1&u=${src}"; then
              mv "${out}.part" "$out" && small_check "$out" "$min" && return 0
            fi
            rm -f "${out}.part" || true

            echo "==> 3) Direto no origin (fallback final)"
            if curl "${COMMON_CURL_OPTS[@]}" --continue-at - -o "${out}.part" \
              "${src}"; then
              mv "${out}.part" "$out" && small_check "$out" "$min" && return 0
            fi
            rm -f "${out}.part" || true

            echo "ERRO FATAL: Não foi possível baixar $src"
            return 1
          }

          A_ARREC="https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Arrecadacao.csv"
          A_DIST="https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Distribuicao.csv"
          A_AUTO="https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Autuacao.csv"
          P_BRUT="https://app.anm.gov.br/DadosAbertos/AMB/Producao_Bruta.csv"
          P_BENF="https://app.anm.gov.br/DadosAbertos/AMB/Producao_Beneficiada.csv"

          # Arrecadação é grande → threshold maior para detectar HTML de erro
          try_all "$A_ARREC" "CFEM_Arrecadacao.csv" 4096
          try_all "$A_DIST" "CFEM_Distribuicao.csv" 2048
          try_all "$A_AUTO" "CFEM_Autuacao.csv" 2048
          try_all "$P_BRUT" "Producao_Bruta.csv" 2048
          try_all "$P_BENF" "Producao_Beneficiada.csv" 2048

          echo ">> Amostras (head):"
          for f in *.csv; do
            echo "---- $f"
            head -n 5 "$f" || true
          done

      - name: Recriar release 'latest'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          if gh release view latest >/dev/null 2>&1; then
            gh release delete latest -y || true
          fi
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true
          gh release create latest --title "latest" --notes "Atualização automática via CF Worker (CSV cru, bounce e fallback)."

      - name: Enviar assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          cd out
          gh release upload latest \
            CFEM_Arrecadacao.csv \
            CFEM_Distribuicao.csv \
            CFEM_Autuacao.csv \
            Producao_Bruta.csv \
            Producao_Beneficiada.csv \
            --clobber

      - name: Listar assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          gh release view latest --json assets --jq '.assets[] | "\(.name)\t\(.size)"'
