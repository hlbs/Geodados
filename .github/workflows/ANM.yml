name: Sync ANM → GitHub Release (CSV)

on:
  schedule:
    - cron: "15 6 * * *"   # 06:15 UTC (~03:15 BRT)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup tools
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p out

      - name: Download ANM CSVs (no urlencode, resume, retries)
        shell: bash
        run: |
          set -euo pipefail
          cd out

          dl () {
            SRC="$1"; OUT="$2"
            echo ">> GET $SRC"
            # Download resiliente com resume (--continue-at -), sem timeout total,
            # e com retry agressivo. SEM URL-ENCODE!
            curl -L --fail-with-body --http1.1 --ipv4 \
                 --retry 12 --retry-delay 10 --retry-all-errors --retry-connrefused \
                 --connect-timeout 60 --max-time 0 \
                 --speed-time 120 --speed-limit 16384 \
                 --continue-at - \
                 -H "User-Agent: Mozilla/5.0 (GitHub Actions)" \
                 -H "Accept: text/csv,application/octet-stream,*/*;q=0.1" \
                 -o "${OUT}.part" "$SRC"

            mv "${OUT}.part" "$OUT"
            BYTES=$(wc -c < "$OUT" | tr -d ' ')
            echo ">> $OUT bytes=$BYTES"
            # Heurística: CSVs reais têm bem mais que 1KB; abaixo disso costuma ser HTML/erro.
            if [ "$BYTES" -lt 1024 ]; then
              echo "!! Arquivo muito pequeno (provável HTML de erro). Dump parcial:"
              head -c 800 "$OUT" || true
              exit 66
            fi

            echo ">> Primeiras linhas:"
            head -n 5 "$OUT" || true
          }

          dl "https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Arrecadacao.csv"  "CFEM_Arrecadacao.csv"
          dl "https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Distribuicao.csv" "CFEM_Distribuicao.csv"
          dl "https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Autuacao.csv"     "CFEM_Autuacao.csv"
          dl "https://app.anm.gov.br/DadosAbertos/AMB/Producao_Bruta.csv"            "Producao_Bruta.csv"
          dl "https://app.anm.gov.br/DadosAbertos/AMB/Producao_Beneficiada.csv"      "Producao_Beneficiada.csv"

      - name: Remove release/tag 'latest' if exists (avoid conflicts)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail

          # Deleta release 'latest' se existir (ignorando erro)
          if gh release view latest >/dev/null 2>&1; then
            echo ">> Deletando release 'latest'…"
            gh release delete latest -y || true
          fi

          # Deleta tag local e remota 'latest' se existirem
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

      - name: Create release 'latest' and upload CSV files (no gzip)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          cd out

          echo ">> Criando release 'latest'…"
          gh release create latest \
            --title "latest" \
            --notes "Atualização automática dos dados ANM (CSV sem URL-encode)" \
            --latest

          echo ">> Enviando assets CSV…"
          # gh lida com arquivos grandes como asset de release (limite por arquivo ~2GB)
          gh release upload latest \
            CFEM_Arrecadacao.csv \
            CFEM_Distribuicao.csv \
            CFEM_Autuacao.csv \
            Producao_Bruta.csv \
            Producao_Beneficiada.csv \
            --clobber

      - name: Show release assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release view latest --json assets --jq '.assets[] | "\(.name)\t\(.size)"'
