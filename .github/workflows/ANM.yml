name: Sync ANM → GitHub Release (via Cloudflare Worker, CSV cru)

on:
  schedule:
    - cron: "15 6 * * *"   # 06:15 UTC (~03:15 BRT)
  workflow_dispatch:

permissions:
  contents: write

env:
  WORKER_BASE: "https://anm.hermesbarros-eng.workers.dev"  # usar ?u=URL CRUA (sem encode!)

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Preparar ambiente
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update -y
          sudo apt-get install -y jq
          mkdir -p out

      - name: Baixar CSVs via Worker (incógnito + sem urlencode)
        shell: bash
        run: |
          set -euo pipefail
          cd out

          UA="Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome Safari"

          # Sem cookies (simula janela anônima) + cabeçalhos "like browser"
          COMMON_CURL_OPTS=(
            -L --fail-with-body --http1.1 --ipv4
            --retry 12 --retry-delay 10 --retry-all-errors --retry-connrefused
            --connect-timeout 60 --max-time 0
            --speed-time 120 --speed-limit 16384
            -H "User-Agent: ${UA}"
            -H "Accept: text/csv,application/octet-stream,*/*;q=0.1"
            -H "Accept-Encoding: identity"
            -H "Origin: https://app.anm.gov.br"
            -H "Referer: https://app.anm.gov.br/"
            -H "Pragma: no-cache"
            -H "Cache-Control: no-cache"
            -H "Cookie:"              # força SEM cookies
          )

          small_check () {
            local f="$1"
            local min="${2:-1024}"
            local sz
            sz=$(wc -c < "$f" | tr -d ' ')
            echo ">> $f bytes=$sz"
            if [ "$sz" -lt "$min" ]; then
              echo "!! Arquivo muito pequeno (provável JSON/HTML de erro). Dump parcial:"
              head -c 800 "$f" || true
              return 66
            fi
            return 0
          }

          dl_worker () {
            local src="$1" out="$2"
            local url="${WORKER_BASE}/?u=${src}"   # URL CRUA, sem urlencode
            echo ">> [worker] GET $url"
            # resume habilitado; grava .part e move se ok
            curl "${COMMON_CURL_OPTS[@]}" --continue-at - -o "${out}.part" "$url"
            mv "${out}.part" "$out"
            small_check "$out" 2048
          }

          # Fontes ANM (todas via Worker)
          A_ARREC="https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Arrecadacao.csv"
          A_DIST="https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Distribuicao.csv"
          A_AUTO="https://app.anm.gov.br/DadosAbertos/ARRECADACAO/CFEM_Autuacao.csv"
          P_BRUT="https://app.anm.gov.br/DadosAbertos/AMB/Producao_Bruta.csv"
          P_BENF="https://app.anm.gov.br/DadosAbertos/AMB/Producao_Beneficiada.csv"

          # Downloads
          dl_worker "$A_ARREC" "CFEM_Arrecadacao.csv"
          dl_worker "$A_DIST"  "CFEM_Distribuicao.csv"
          dl_worker "$A_AUTO"  "CFEM_Autuacao.csv"
          dl_worker "$P_BRUT"  "Producao_Bruta.csv"
          dl_worker "$P_BENF"  "Producao_Beneficiada.csv"

          echo ">> Amostras:"
          for f in *.csv; do
            echo "---- $f"
            head -n 5 "$f" || true
          done

      - name: Recriar release 'latest' (evita conflitos de tag/asset)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          # Remove release/tag se existir (evita Validation Failed: already_exists)
          if gh release view latest >/dev/null 2>&1; then
            gh release delete latest -y || true
          fi
          git tag -d latest 2>/dev/null || true
          git push origin :refs/tags/latest 2>/dev/null || true

          gh release create latest \
            --title "latest" \
            --notes "Atualização automática via Cloudflare Worker (CSV cru, sem urlencode)."

      - name: Enviar assets (CSV cru)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          cd out
          gh release upload latest \
            CFEM_Arrecadacao.csv \
            CFEM_Distribuicao.csv \
            CFEM_Autuacao.csv \
            Producao_Bruta.csv \
            Producao_Beneficiada.csv \
            --clobber

      - name: Listar assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release view latest --json assets --jq '.assets[] | "\(.name)\t\(.size)"'
